spring:
  application:
    name: gateway
  
  config:
    import: "optional:configserver:"
  
  # Redis 연결 설정 (논블로킹)
  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      # SSL 설정 (Upstash 사용 시 필수)
      ssl:
        enabled: ${REDIS_SSL_ENABLED:false}
  
  # WebFlux 튜닝
  webflux:
    codec:
      max-in-memory-size: 10MB
  
  cloud:
    config:
      enabled: false
      import-check:
        enabled: false
    
    gateway:
      # HTTP 클라이언트 타임아웃 및 연결 풀 설정
      httpclient:
        connect-timeout: 10000
        response-timeout: 30s
        pool:
          max-connections: 1000
          max-idle-time: 30s
      
      # 로드밸런서 캐시 설정
      loadbalancer:
        cache:
          enabled: true
          ttl: 35s
      
      # 전역 필터 (모든 라우트에 적용)
      default-filters:
        - AddRequestHeader=X-Gateway-Request, Gateway-Request
      
      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins:
              - "http://localhost:3000"
              - "http://127.0.0.1:3000"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600
            exposed-headers:
              - Authorization
              - Content-Type
      
      routes:
        # ========================================
        # Swagger UI 및 API Docs
        # ========================================
        
        # Swagger UI Redirect Route
        - id: swagger-redirect
          uri: http://localhost:8080
          predicates:
            - Path=/docs
          filters:
            - RewritePath=/docs, /swagger-ui.html
        
        # OpenAPI Docs Proxy Routes
        - id: user-api-docs
          uri: http://user:8080
          predicates:
            - Path=/api-docs/user
          filters:
            - RewritePath=/api-docs/user, /v3/api-docs
        
        - id: common-api-docs
          uri: http://common:8080
          predicates:
            - Path=/api-docs/common
          filters:
            - RewritePath=/api-docs/common, /v3/api-docs
        
        - id: environment-api-docs
          uri: http://environment:8080
          predicates:
            - Path=/api-docs/environment
          filters:
            - RewritePath=/api-docs/environment, /v3/api-docs
        
        - id: social-api-docs
          uri: http://social:8080
          predicates:
            - Path=/api-docs/social
          filters:
            - RewritePath=/api-docs/social, /v3/api-docs
        
        - id: governance-api-docs
          uri: http://governance:8080
          predicates:
            - Path=/api-docs/governance
          filters:
            - RewritePath=/api-docs/governance, /v3/api-docs
        
        - id: oauth-api-docs
          uri: http://oauth-service:8085
          predicates:
            - Path=/api-docs/oauth
          filters:
            - RewritePath=/api-docs/oauth, /v3/api-docs
        
        - id: crawler-api-docs
          uri: http://crawler-service:9001
          predicates:
            - Path=/api-docs/crawler
          filters:
            - RewritePath=/api-docs/crawler, /openapi.json
        
        - id: chatbot-api-docs
          uri: http://chatbot-service:9002
          predicates:
            - Path=/api-docs/chatbot
          filters:
            - RewritePath=/api-docs/chatbot, /openapi.json
        
        # ========================================
        # Spring Boot Services
        # ========================================
        
        # User Service
        - id: user-service-route
          uri: http://user:8080
          predicates:
            - Path=/api/user/**
          filters:
            - RewritePath=/api/user/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
        
        # Common Service
        - id: common-service-route
          uri: http://common:8080
          predicates:
            - Path=/api/common/**
          filters:
            - RewritePath=/api/common/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: commonCircuitBreaker
        
        # Environment Service
        - id: environment-service-route
          uri: http://environment:8080
          predicates:
            - Path=/api/environment/**
          filters:
            - RewritePath=/api/environment/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: environmentCircuitBreaker
        
        # Social Service
        - id: social-service-route
          uri: http://social:8080
          predicates:
            - Path=/api/social/**
          filters:
            - RewritePath=/api/social/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: socialCircuitBreaker
        
        # Governance Service
        - id: governance-service-route
          uri: http://governance:8080
          predicates:
            - Path=/api/governance/**
          filters:
            - RewritePath=/api/governance/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: governanceCircuitBreaker
        
        # ========================================
        # OAuth Service (Google Login)
        # ========================================
        
        # OAuth Service - API 경로 (프론트엔드에서 호출)
        # /api/oauth/google/auth-url, /api/oauth/google/login
        - id: oauth-service-route
          uri: http://oauth-service:8085
          predicates:
            - Path=/api/oauth/**
          filters:
            - RewritePath=/api/oauth/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: oauthCircuitBreaker
        
        # OAuth Callback 경로 (구글 리디렉션용)
        # /oauth/google/callback
        - id: oauth-callback-route
          uri: http://oauth-service:8085
          predicates:
            - Path=/oauth/**
          filters:
            - RewritePath=/oauth/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: oauthCircuitBreaker
        
        # ========================================
        # FastAPI Services (AI/ML)
        # ========================================
        
        # Crawler Service
        - id: crawler-service-route
          uri: http://crawler-service:9001
          predicates:
            - Path=/api/crawler/**
          filters:
            - RewritePath=/api/crawler/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: crawlerCircuitBreaker
        
        # Chatbot Service
        - id: chatbot-service-route
          uri: http://chatbot-service:9002
          predicates:
            - Path=/api/chatbot/**
          filters:
            - RewritePath=/api/chatbot/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: chatbotCircuitBreaker
        
        # ML Service (Titanic)
        - id: titanic-service-route
          uri: http://ml-service:9003
          predicates:
            - Path=/api/titanic/**
          filters:
            - RewritePath=/api/titanic/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: titanicCircuitBreaker
        
        # ML Service (ESG Grade)
        - id: grade-service-route
          uri: http://ml-service:9003
          predicates:
            - Path=/api/grade/**
          filters:
            - RewritePath=/api/grade/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: gradeCircuitBreaker

# ========================================
# Resilience4j Circuit Breaker 설정
# ========================================
resilience4j:
  circuitbreaker:
    instances:
      userCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      commonCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      environmentCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      socialCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      governanceCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      crawlerCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      chatbotCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      mlCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      titanicCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      gradeCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
      oauthCircuitBreaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
  timelimiter:
    instances:
      oauthCircuitBreaker:
        timeout-duration: 30s

# ========================================
# Actuator 설정 (모니터링)
# ========================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: always
  metrics:
    tags:
      application: ${spring.application.name}

# ========================================
# SpringDoc OpenAPI 설정
# ========================================
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /docs
    enabled: true
    operations-sorter: method
    tags-sorter: alpha
    use-root-path: false
    persist-authorization: true
    urls:
      - url: /v3/api-docs
        name: Gateway
      - url: /api-docs/user
        name: User Service
      - url: /api-docs/common
        name: Common Service
      - url: /api-docs/environment
        name: Environment Service
      - url: /api-docs/social
        name: Social Service
      - url: /api-docs/governance
        name: Governance Service
      - url: /api-docs/crawler
        name: Crawler Service (FastAPI)
      - url: /api-docs/chatbot
        name: Chatbot Service (FastAPI)
      - url: /api-docs/oauth
        name: OAuth Service (Google Login)
  show-actuator: false
  default-flat-param-object: true
  writer-with-order-by-keys: true

# ========================================
# Server 설정
# ========================================
server:
  port: 8080

# ========================================
# Logging Configuration
# ========================================
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.cloud.gateway.filter: DEBUG
    org.springframework.web: INFO
    reactor.netty: INFO
    reactor.netty.http: DEBUG
    site.aifixr.gateway: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
